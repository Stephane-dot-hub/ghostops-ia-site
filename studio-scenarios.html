<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>GhostOps Studio Scénarios – Espace IA Niveau 2</title>
    <meta
      name="description"
      content="Espace IA sécurisé du GhostOps Studio Scénarios : construction de 2 à 3 scénarios tactiques comparables à partir de votre Diagnostic IA ou de votre dossier consolidé."
    />
    <meta name="robots" content="noindex, nofollow" />
    <link rel="canonical" href="https://www.ghostops.tech/studio-scenarios-session.html" />

    <!-- Open Graph -->
    <meta property="og:title" content="GhostOps Studio Scénarios – Espace IA Niveau 2" />
    <meta
      property="og:description"
      content="Module IA dédié au GhostOps Studio Scénarios : scénarios tactiques, matrices risques/gains/exposition et conditions de faisabilité."
    />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://www.ghostops.tech/studio-scenarios-session.html" />
    <meta property="og:image" content="https://www.ghostops.tech/assets/ghostops-opengraph.jpg" />

    <!-- Fonts & Tailwind -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { theme: { extend: { fontFamily: { sans: ["Inter", "sans-serif"] } } } };
    </script>

    <style>
      body::before {
        content: "";
        background: url("/assets/background-ghostops.jpg") no-repeat center center fixed;
        background-color: #0f172a;
        background-size: cover;
        animation: bgPulse 10s ease-in-out infinite alternate;
        position: fixed;
        inset: 0;
        opacity: 0.25;
        z-index: -1;
        transition: opacity 0.4s ease;
      }
      @keyframes bgPulse {
        0% { filter: brightness(1) contrast(1); }
        100% { filter: brightness(1.05) contrast(1.05); }
      }
      .text-shadow { text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.6); }
      html { scroll-behavior: smooth; }
      header, main, section, footer { position: relative; z-index: 1; }

      /* Bulles lisibles */
      .bot-bubble {
        white-space: normal;
        line-height: 1.55;
      }
      .bot-bubble ul {
        list-style: disc;
        padding-left: 1.2rem;
        margin: 0.35rem 0 0.35rem 0;
      }
      .bot-bubble li { margin: 0.15rem 0; }
      .bot-bubble strong { font-weight: 700; }
      .bot-bubble p { margin: 0.25rem 0; }

      .ghostops-btn {
        border: 1px solid rgba(148, 163, 184, 0.35);
      }
    </style>
  </head>

  <body class="bg-gray-900 text-white font-sans leading-relaxed">
    <!-- HEADER -->
    <header class="w-full px-6 md:px-16 py-4 flex items-center justify-between">
      <a href="/index.html" class="text-sm font-semibold tracking-[.25em] text-gray-200 hover:text-white uppercase">
        GHOST<span class="text-gray-400">OPS</span>
      </a>
      <nav class="flex items-center gap-4 text-xs md:text-sm">
        <a href="/index.html" class="text-gray-300 hover:text-white">Accueil</a>
        <a href="/expertise.html" class="text-gray-300 hover:text-white">Expertise</a>
        <a href="/qui-sommes-nous.html" class="text-gray-300 hover:text-white">Qui sommes-nous&nbsp;?</a>
        <a
          href="/contact.html"
          class="px-3 py-1 border border-gray-400 rounded-full hover:bg-gray-100 hover:text-black transition"
        >
          Contact confidentiel
        </a>
      </nav>
    </header>

    <main class="px-6 md:px-24 pb-20">
      <!-- Bandeau paiement validé -->
      <section class="max-w-4xl mx-auto mt-6">
        <div
          id="ghostops-studio-paid-banner"
          class="hidden mb-4 rounded-xl border border-emerald-500/70 bg-emerald-900/40 px-4 py-3 text-xs md:text-sm text-emerald-100"
        >
          <p class="font-semibold mb-1">Paiement GhostOps Studio Scénarios confirmé.</p>
          <p>
            Vous êtes dans l’espace IA dédié au <span class="font-semibold">Niveau&nbsp;2 – GhostOps Studio Scénarios</span>.
            Les échanges qui suivent servent à préparer vos <span class="font-semibold">2 à 3 scénarios tactiques</span>.
          </p>
        </div>
      </section>

      <!-- CONTEXTE NIVEAU 2 -->
      <section class="max-w-4xl mx-auto mt-4 mb-6">
        <p class="text-xs uppercase tracking-[.25em] text-gray-400 mb-3">GhostOps IA – Niveau&nbsp;2 · Studio Scénarios</p>
        <h1 class="text-2xl md:text-3xl font-bold mb-4 text-white text-shadow">Espace IA – GhostOps Studio Scénarios</h1>
        <p class="text-gray-200 text-sm md:text-base mb-3">
          Cet espace est réservé au <span class="font-semibold">Niveau&nbsp;2 de la suite GhostOps IA</span>.
          Il a pour objectif de transformer votre <span class="font-semibold">Diagnostic IA</span> ou votre dossier consolidé
          en <span class="font-semibold">2 à 3 scénarios tactiques comparables</span>.
        </p>
        <p class="text-gray-300 text-xs md:text-sm mb-3">
          L’IA GhostOps ne remplace pas l’intervention humaine ni les arbitrages de gouvernance. Elle sert ici à
          <span class="font-semibold">structurer les options</span>, clarifier les <span class="font-semibold">risques / gains / expositions</span>
          et tester différentes lignes d’action.
        </p>
        <p class="text-gray-400 text-[11px] md:text-xs">
          Évitez de saisir des noms complets ou des données directement identifiantes. Restez centré sur les fonctions, les comportements,
          les rapports de force et les enjeux (humains, politiques, réputationnels).
        </p>
      </section>

      <!-- CARTOUCHE DE TRAVAIL IA -->
      <section class="max-w-4xl mx-auto">
        <div class="bg-gray-900/80 border border-gray-700 rounded-2xl p-5 md:p-6">
          <h2 class="text-lg md:text-xl font-semibold mb-3 text-white text-shadow">
            Atelier IA – Construction de scénarios tactiques
          </h2>

          <div class="mt-5">
            <!-- Zone messages -->
            <div
              id="ghostops-studio-messages"
              class="bg-gray-950/80 border border-gray-800 rounded-xl px-3 py-3 h-64 md:h-80 overflow-y-auto text-xs md:text-sm space-y-2"
            >
              <div class="text-gray-200 text-xs md:text-[13px]">
                <span class="font-semibold">GhostOps IA – Studio Scénarios&nbsp;:</span>
                <span>
                  Pour commencer, décrivez votre situation en précisant&nbsp;: (1) le contexte, (2) les acteurs et leurs positions,
                  (3) ce que vous cherchez surtout à éviter, (4) ce qui serait considéré comme une issue acceptable.
                  <br /><br />
                  Je répondrai avec une première structuration et 2 à 3 scénarios à approfondir.
                </span>
              </div>
            </div>

            <!-- Bouton suite -->
            <div class="mt-3 flex items-center gap-2">
              <button
                id="ghostops-studio-continue"
                type="button"
                class="hidden ghostops-btn text-xs md:text-sm px-4 py-2 rounded-md bg-gray-900/70 hover:bg-gray-800 text-gray-100"
              >
                Demander la suite
              </button>
              <span id="ghostops-studio-continue-hint" class="hidden text-[11px] md:text-xs text-gray-400">
                La suite ne consomme pas d’itération.
              </span>
            </div>

            <!-- Form -->
            <form id="ghostops-studio-form" class="mt-3 flex flex-col gap-2 md:flex-row md:items-end">
              <textarea
                id="ghostops-studio-input"
                class="flex-1 text-xs md:text-sm bg-gray-900 text-gray-100 border border-gray-700 rounded-md px-2 py-2 resize-none focus:outline-none focus:border-gray-400"
                rows="3"
                placeholder="Décrivez votre situation (contexte, acteurs, contraintes, ce que vous cherchez à sécuriser)…"
              ></textarea>
              <button type="submit" class="mt-1 md:mt-0 md:ml-2 text-xs md:text-sm px-4 py-2 bg-white text-black font-semibold rounded-md hover:bg-gray-200">
                Envoyer
              </button>
            </form>

            <p class="mt-3 text-[11px] md:text-xs text-gray-500">
              Cet espace IA prépare les scénarios. La validation finale, le cadrage des décisions et les communications sensibles restent assumés par des humains.
            </p>
          </div>
        </div>
      </section>
    </main>

    <footer class="w-full px-6 md:px-24 pb-8 mt-10 text-xs text-gray-400">
      <div class="max-w-5xl mx-auto flex flex-col md:flex-row md:items-center md:justify-between gap-2">
        <p>© GhostOps – Tous droits réservés.</p>
        <nav class="flex flex-wrap items-center gap-3">
          <a href="/" class="hover:underline">Accueil</a>
          <a href="/expertise.html" class="hover:underline">Expertise</a>
          <a href="/qui-sommes-nous.html" class="hover:underline">Qui sommes-nous&nbsp;?</a>
          <a href="/contact.html" class="hover:underline">Contact</a>
          <a href="/mentions-legales.html" class="hover:underline">Mentions légales &amp; confidentialité</a>
        </nav>
      </div>
    </footer>

    <script>
      (function () {
        const TRUNC_MARKER = "— FIN TRONQUÉE (demander la suite)";

        const params = new URLSearchParams(window.location.search);
        const csId = params.get("cs_id") || "";
        const paid = params.get("paid");
        const paidBanner = document.getElementById("ghostops-studio-paid-banner");

        // Affiche le bandeau si payé=1 OU si cs_id présent (cas standard Stripe)
        if ((paid === "1" || csId) && paidBanner) {
          paidBanner.classList.remove("hidden");
        }

        const form = document.getElementById("ghostops-studio-form");
        const input = document.getElementById("ghostops-studio-input");
        const messages = document.getElementById("ghostops-studio-messages");

        const btnContinue = document.getElementById("ghostops-studio-continue");
        const hintContinue = document.getElementById("ghostops-studio-continue-hint");

        if (!form || !input || !messages) return;

        // État session
        let sessionToken = "";
        let itersLeft = null;
        let lastAssistantRaw = "";
        let history = []; // {role:"user"|"assistant", content:"..."}

        function scrollToBottom() {
          messages.scrollTop = messages.scrollHeight;
        }

        function escapeHtml(str) {
          return String(str || "")
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
        }

        // Convertit un texte Markdown simple (vos contraintes) en HTML aéré
        function formatAiTextToHtml(raw) {
          const text = String(raw || "").replace(/\r\n/g, "\n").trim();
          if (!text) return "";

          // On travaille ligne par ligne
          const lines = text.split("\n");
          let html = "";
          let inUl = false;

          const closeUl = () => {
            if (inUl) {
              html += "</ul>";
              inUl = false;
            }
          };

          for (let i = 0; i < lines.length; i++) {
            const line = lines[i];

            // Ligne vide => saut de paragraphe
            if (!line.trim()) {
              closeUl();
              html += "<p></p>";
              continue;
            }

            // Puce "- "
            if (line.trim().startsWith("- ")) {
              if (!inUl) {
                html += "<ul>";
                inUl = true;
              }
              let li = line.trim().slice(2);
              li = escapeHtml(li);

              // gras **...**
              li = li.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
              html += `<li>${li}</li>`;
              continue;
            }

            // Titres en gras sur une ligne "**...**"
            const m = line.trim().match(/^\*\*(.+?)\*\*$/);
            if (m) {
              closeUl();
              const title = escapeHtml(m[1]).replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
              html += `<p><strong>${title}</strong></p>`;
              continue;
            }

            // Ligne normale
            closeUl();
            let p = escapeHtml(line).replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
            html += `<p>${p}</p>`;
          }

          closeUl();
          // Nettoyage des paragraphes vides successifs
          html = html.replace(/<p><\/p>\s*(<p><\/p>\s*)+/g, "<p></p>");
          return html;
        }

        function addMessageBubble(sender) {
          const wrapper = document.createElement("div");
          wrapper.className = sender === "user" ? "text-right" : "text-left";

          const bubble = document.createElement("div");
          bubble.className =
            sender === "user"
              ? "inline-block bg-blue-500 text-white text-xs md:text-sm px-3 py-2 rounded-lg mb-1"
              : "inline-block bg-gray-800 text-gray-100 text-xs md:text-sm px-3 py-2 rounded-lg mb-1 bot-bubble";

          // On tapera du texte brut dans bubble.textContent, puis on hydratera en HTML
          wrapper.appendChild(bubble);
          messages.appendChild(wrapper);
          scrollToBottom();
          return bubble;
        }

        function hideContinue() {
          btnContinue.classList.add("hidden");
          hintContinue.classList.add("hidden");
        }

        function showContinue() {
          btnContinue.classList.remove("hidden");
          hintContinue.classList.remove("hidden");
        }

        function stripTruncMarker(text) {
          const t = String(text || "");
          if (!t.includes(TRUNC_MARKER)) return { cleaned: t, truncated: false };
          return { cleaned: t.replace(TRUNC_MARKER, "").trim(), truncated: true };
        }

        async function typewriterText(el, fullText, speedMs) {
          el.textContent = "";
          const txt = String(fullText || "");
          for (let i = 0; i < txt.length; i++) {
            el.textContent += txt[i];
            if (i % 2 === 0) scrollToBottom();
            await new Promise((r) => setTimeout(r, speedMs));
          }
          scrollToBottom();
        }

        async function renderBotReply(replyRaw) {
          // Stocke la version brute côté client (utile pour "continue")
          lastAssistantRaw = String(replyRaw || "");

          const { cleaned, truncated } = stripTruncMarker(lastAssistantRaw);

          // Effet machine à écrire sur le texte brut
          const bubble = addMessageBubble("bot");
          await typewriterText(bubble, cleaned, 8);

          // Puis conversion en HTML aéré (puces, titres)
          const html = formatAiTextToHtml(cleaned);
          if (html) {
            bubble.innerHTML = html;
          }

          // Affiche le bouton suite si tronqué
          if (truncated) showContinue();
          else hideContinue();

          // Historique (on conserve la version "cleaned" sans marqueur)
          history.push({ role: "assistant", content: cleaned });
        }

        async function callApi(payload) {
          const resp = await fetch("/api/ghostops-studio-scenarios", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          let data = {};
          try { data = await resp.json(); } catch (_) {}
          return { ok: resp.ok, status: resp.status, data };
        }

        async function sendUserMessage() {
          hideContinue();

          const userText = (input.value || "").trim();
          if (!userText) return;

          // garde-fou longueur (évite latence/timeout inutiles)
          if (userText.length > 4000) {
            const b = addMessageBubble("bot");
            b.textContent = "Message trop long. Merci de condenser (max ~4000 caractères) ou de découper en 2 envois.";
            return;
          }

          // UI + historique
          const userBubble = addMessageBubble("user");
          userBubble.textContent = userText;
          history.push({ role: "user", content: userText });

          input.value = "";

          // message attente
          const waiting = addMessageBubble("bot");
          waiting.textContent = "Lecture scénarios en cours…";

          try {
            const payload =
              sessionToken
                ? { sessionToken, message: userText, history }
                : { cs_id: csId, message: userText }; // 1er appel : cs_id obligatoire

            const { ok, data } = await callApi(payload);

            // retire "Lecture..."
            if (waiting && waiting.parentNode) waiting.parentNode.removeChild(waiting);

            if (!ok || !data.reply) {
              const b = addMessageBubble("bot");
              b.textContent = data.error || "Une erreur est survenue (Studio Scénarios). Veuillez réessayer.";
              return;
            }

            // met à jour session
            if (data.sessionToken) sessionToken = data.sessionToken;
            if (typeof data.itersLeft === "number") itersLeft = data.itersLeft;

            await renderBotReply(data.reply);
          } catch (err) {
            console.error("Erreur /api/ghostops-studio-scenarios :", err);
            if (waiting && waiting.parentNode) waiting.parentNode.removeChild(waiting);
            const b = addMessageBubble("bot");
            b.textContent = "Erreur de connexion à GhostOps IA. Veuillez réessayer ou utiliser la page contact.";
          }
        }

        async function requestContinue() {
          if (!sessionToken) return;
          if (!lastAssistantRaw) return;

          // UI attente
          const waiting = addMessageBubble("bot");
          waiting.textContent = "Suite en cours…";

          try {
            const payload = {
              sessionToken,
              continue: true,
              last_assistant: lastAssistantRaw,
              history,
            };

            const { ok, data } = await callApi(payload);

            if (waiting && waiting.parentNode) waiting.parentNode.removeChild(waiting);

            if (!ok || !data.reply) {
              const b = addMessageBubble("bot");
              b.textContent = data.error || "Impossible de récupérer la suite. Veuillez réessayer.";
              return;
            }

            // met à jour session (rotation token)
            if (data.sessionToken) sessionToken = data.sessionToken;
            if (typeof data.itersLeft === "number") itersLeft = data.itersLeft;

            // Important : la réponse "continue" est un nouvel assistant, on l'ajoute à l’historique
            await renderBotReply(data.reply);
          } catch (err) {
            console.error("Erreur continue :", err);
            if (waiting && waiting.parentNode) waiting.parentNode.removeChild(waiting);
            const b = addMessageBubble("bot");
            b.textContent = "Erreur lors de la récupération de la suite. Veuillez réessayer.";
          }
        }

        // Events
        form.addEventListener("submit", function (e) {
          e.preventDefault();
          sendUserMessage();
        });

        input.addEventListener("keydown", function (e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendUserMessage();
          }
        });

        btnContinue.addEventListener("click", function () {
          requestContinue();
        });

        // Si pas de cs_id dans l’URL, l’espace ne peut pas initier la session (Niveau 2 indépendant)
        if (!csId) {
          const b = addMessageBubble("bot");
          b.textContent =
            "Accès non initialisé : identifiant de paiement manquant (cs_id). Veuillez revenir depuis la page de confirmation de paiement.";
        }
      })();
    </script>
  </body>
</html>
