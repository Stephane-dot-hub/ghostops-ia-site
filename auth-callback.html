<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GhostOps — Validation de connexion</title>
    <meta name="robots" content="noindex, nofollow" />
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; background: #0b0f19; color: #e6e8ee; }
      .wrap { max-width: 560px; margin: 10vh auto; padding: 24px; text-align: center; }
      .card { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.10); border-radius: 14px; padding: 26px; }
      .title { font-size: 18px; margin: 0 0 10px; }
      .txt { opacity: 0.9; line-height: 1.5; margin: 0; }
      .err { color: #FF7C7C; margin-top: 12px; font-size: 13px; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <div class="title">Connexion en cours…</div>
        <p class="txt">Nous finalisons votre session sécurisée. Vous allez être redirigé automatiquement.</p>
        <div id="err" class="err"></div>
      </div>
    </div>

    <script type="module">
      import { supabase } from "./js/config.js";

      const errEl = document.getElementById("err");

      function setErr(t) {
        errEl.textContent = t || "";
      }

      (async () => {
        try {
          // Selon configuration Supabase, on peut recevoir ?code=...
          const url = new URL(window.location.href);
          const code = url.searchParams.get("code");

          if (code) {
            const { error } = await supabase.auth.exchangeCodeForSession(code);
            if (error) throw error;
          }

          const { data } = await supabase.auth.getSession();
          if (!data?.session) {
            setErr("Session non établie. Merci de réessayer depuis la page de connexion.");
            return;
          }

          // Redirection vers votre “espace”
          window.location.replace("./espace.html");
        } catch (e) {
          setErr(e?.message || "Erreur inconnue lors de la validation.");
        }
      })();
    </script>
  </body>
</html>
