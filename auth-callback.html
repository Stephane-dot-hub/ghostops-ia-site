<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GhostOps — Validation de connexion</title>
    <meta name="robots" content="noindex, nofollow" />
    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
        margin: 0;
        background: #0b0f19;
        color: #e6e8ee;
        display: grid;
        place-items: center;
        min-height: 100vh;
      }
      .card {
        width: min(560px, calc(100vw - 32px));
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 14px;
        padding: 22px;
      }
      h1 { font-size: 18px; margin: 0 0 8px; }
      p { margin: 0; opacity: 0.9; line-height: 1.5; font-size: 13px; }
      .err { margin-top: 10px; color: #ff7c7c; }
      .muted { margin-top: 10px; opacity: 0.75; font-size: 12px; }
      a { color: #cdd6ff; text-decoration: underline; }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Validation de connexion…</h1>
      <p>Veuillez patienter, vous allez être redirigé automatiquement.</p>
      <p id="err" class="err" style="display:none;"></p>
      <p class="muted">
        Si rien ne se passe, <a href="/connexion.html">retourner à la page de connexion</a>.
      </p>
    </div>

    <!-- 1) SDK Supabase (navigateur) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- 2) Votre config -->
    <script src="/config.js"></script>

    <script>
      (function () {
        const supabase = window.ghostopsSupabase;
        const errEl = document.getElementById("err");

        function showErr(msg) {
          errEl.textContent = msg;
          errEl.style.display = "block";
        }

        function sanitizeInternalPath(p, fallback) {
          const fb = fallback ?? "/index.html";
          let v = String(p || "").trim();
          if (!v) return fb;

          // Refuser URLs absolues
          if (v.startsWith("http://") || v.startsWith("https://")) return fb;

          // Si "next" arrive encodé en dur (%2F...%3F...)
          try {
            if (v.includes("%2F") || v.includes("%3F") || v.includes("%3D")) {
              v = decodeURIComponent(v);
            }
          } catch (_) {}

          if (!v.startsWith("/")) v = "/" + v;
          if (v.includes("..")) return fb;

          return v;
        }

        function getNextFromUrl() {
          const u = new URL(window.location.href);
          const n = u.searchParams.get("next");
          return sanitizeInternalPath(n, null);
        }

        function getStoredNext() {
          try {
            return sanitizeInternalPath(localStorage.getItem("ghostops_return_to"), null);
          } catch {
            return null;
          }
        }

        async function run() {
          if (!supabase?.auth) {
            showErr("Supabase non initialisé. Vérifiez /config.js et le chargement du SDK.");
            setTimeout(() => (window.location.href = "/connexion.html?reason=supabase_missing"), 1200);
            return;
          }

          // 1) Laisser Supabase traiter l'URL (code/token) et installer la session
          // NB: getSession() suffit généralement avec detectSessionInUrl:true dans createClient()
          try {
            await supabase.auth.getSession();
          } catch (e) {
            // même si ça échoue, on tente une redirection vers connexion
            showErr("Impossible de finaliser la session. Reconnexion requise.");
            setTimeout(() => (window.location.href = "/connexion.html?reason=no_session"), 1200);
            return;
          }

          // 2) Choisir la cible
          const nextFromUrl = getNextFromUrl();
          const nextStored = getStoredNext();
          const target = nextFromUrl || nextStored || "/index.html";

          // 3) Redirection finale
          window.location.replace(target);
        }

        run();
      })();
    </script>
  </body>
</html>
