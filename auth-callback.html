<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GhostOps — Validation de connexion</title>
    <meta name="robots" content="noindex, nofollow" />
    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
        margin: 0;
        background: #0b0f19;
        color: #e6e8ee;
        display: grid;
        place-items: center;
        min-height: 100vh;
      }
      .card {
        width: min(560px, calc(100vw - 32px));
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 14px;
        padding: 22px;
      }
      h1 { font-size: 18px; margin: 0 0 8px; }
      p { margin: 0; opacity: 0.9; line-height: 1.5; font-size: 13px; }
      .err { margin-top: 10px; color: #ff7c7c; }
      .muted { margin-top: 10px; opacity: 0.75; font-size: 12px; }
      a { color: #cdd6ff; text-decoration: underline; }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Validation de connexion…</h1>
      <p>Veuillez patienter, vous allez être redirigé automatiquement.</p>
      <p id="err" class="err" style="display:none;"></p>
      <p class="muted">
        Si rien ne se passe, <a href="/connexion.html">retourner à la page de connexion</a>.
      </p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/config.js"></script>

    <script>
      (function () {
        const supabase = window.ghostopsSupabase;
        const errEl = document.getElementById("err");

        const RETURN_KEY = "ghostops_return_to";
        const RETURN_TTL_MS = 30 * 60 * 1000; // 30 minutes

        function showErr(msg) {
          errEl.textContent = msg;
          errEl.style.display = "block";
        }

        function sanitizeInternalPath(p, fallback) {
          const fb = fallback ?? "/index.html";
          let v = String(p || "").trim();
          if (!v) return fb;
          if (v.startsWith("http://") || v.startsWith("https://")) return fb;
          try {
            if (v.includes("%2F") || v.includes("%3F") || v.includes("%3D")) {
              v = decodeURIComponent(v);
            }
          } catch (_) {}
          if (!v.startsWith("/")) v = "/" + v;
          if (v.includes("..")) return fb;
          return v;
        }

        function setWithTTL(key, value, ttlMs) {
          try {
            const payload = { v: String(value || ""), exp: Date.now() + Number(ttlMs || 0) };
            localStorage.setItem(key, JSON.stringify(payload));
          } catch (_) {}
        }

        function getWithTTL(key) {
          try {
            const raw = localStorage.getItem(key);
            if (!raw) return null;

            if (raw[0] !== "{") {
              const v = sanitizeInternalPath(raw, null);
              if (v) setWithTTL(key, v, RETURN_TTL_MS);
              return v;
            }

            const obj = JSON.parse(raw);
            const exp = Number(obj?.exp || 0);
            const v = sanitizeInternalPath(obj?.v, null);

            if (!v) {
              localStorage.removeItem(key);
              return null;
            }
            if (!exp || Date.now() > exp) {
              localStorage.removeItem(key);
              return null;
            }
            return v;
          } catch (_) {
            try { localStorage.removeItem(key); } catch {}
            return null;
          }
        }

        function getNextFromUrl() {
          const u = new URL(window.location.href);
          const n = u.searchParams.get("next");
          return sanitizeInternalPath(n, null);
        }

        function getStoredNext() {
          return getWithTTL(RETURN_KEY);
        }

        async function run() {
          if (!supabase?.auth) {
            showErr("Supabase non initialisé. Vérifiez /config.js et le chargement du SDK.");
            setTimeout(() => (window.location.href = "/connexion.html?reason=supabase_missing"), 1200);
            return;
          }

          try {
            await supabase.auth.getSession();
          } catch (e) {
            showErr("Impossible de finaliser la session. Reconnexion requise.");
            setTimeout(() => (window.location.href = "/connexion.html?reason=no_session"), 1200);
            return;
          }

          const nextFromUrl = getNextFromUrl();
          const nextStored = getStoredNext();
          const target = nextFromUrl || nextStored || "/index.html";

          // Optionnel : “rafraîchir” le retour en TTL si target est valide
          if (target) setWithTTL(RETURN_KEY, target, RETURN_TTL_MS);

          window.location.replace(target);
        }

        run();
      })();
    </script>
  </body>
</html>
