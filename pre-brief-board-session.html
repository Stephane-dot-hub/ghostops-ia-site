<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>GhostOps Pré-brief Board – Espace de travail & activation</title>
    <meta
      name="description"
      content="Espace de travail GhostOps Pré-brief Board, réservé aux dirigeants et boards ayant validé le paiement. Rappel du périmètre, préparation des éléments et première structuration du dossier."
    />

    <meta name="robots" content="noindex, nofollow" />
    <link rel="canonical" href="https://www.ghostops.tech/pre-brief-board-session.html" />

    <!-- Open Graph -->
    <meta property="og:title" content="GhostOps Pré-brief Board – Espace de travail" />
    <meta
      property="og:description"
      content="Session Pré-brief Board GhostOps : espace de travail confidentiel pour structurer votre note board-ready après validation du paiement."
    />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://www.ghostops.tech/pre-brief-board-session.html" />
    <meta property="og:image" content="https://www.ghostops.tech/assets/ghostops-opengraph.jpg" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="GhostOps Pré-brief Board – Session" />
    <meta name="twitter:description" content="Espace de travail confidentiel réservé aux Pré-brief Board GhostOps." />
    <meta name="twitter:image" content="https://www.ghostops.tech/assets/ghostops-opengraph.jpg" />

    <!-- Fonts & Tailwind -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: { extend: { fontFamily: { sans: ["Inter", "sans-serif"] } } },
      };
    </script>

    <!-- ✅ Supabase + config.js -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/config.js"></script>

    <!-- ✅ Niveau produit (doit être défini AVANT activation + auth-guard) -->
    <script>
      window.GHOSTOPS_NIVEAU_PRODUIT = "pre-brief";
    </script>

    <!-- ✅ Activation du droit (Option B) : uniquement si cs_id présent, puis nettoyage URL -->
    <script>
      (function () {
        const params = new URLSearchParams(window.location.search);
        const csId = (params.get("cs_id") || "").trim();
        const niveauProduit = window.GHOSTOPS_NIVEAU_PRODUIT; // "diagnostic" | "studio" | "pre-brief"

        if (!csId) return;

        async function activateRight() {
          const supabase = window.ghostopsSupabase;
          if (!supabase?.auth) throw new Error("Supabase non prêt");

          const { data } = await supabase.auth.getSession();
          const accessToken = data?.session?.access_token;
          if (!accessToken) throw new Error("Session Supabase absente");

          const r = await fetch("/api/ghostops-activate-right", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + accessToken,
            },
            body: JSON.stringify({ cs_id: csId, niveau_produit: niveauProduit }),
          });

          const j = await r.json().catch(() => ({}));
          if (!r.ok || !j.ok) throw new Error(j.error || "Activation impossible");

          // Nettoyage URL : on retire cs_id
          const url = new URL(window.location.href);
          url.searchParams.delete("cs_id");
          url.searchParams.set("activated", "1");
          window.location.replace(url.toString());
        }

        // Déclenché par auth-guard lorsqu'il détecte un paiement sans droit encore créé
        window.addEventListener("ghostops:auth", function (e) {
          const detail = e?.detail || {};
          if (detail.reason !== "activation_required") return;

          const onceKey = "ghostops_activation_once_" + niveauProduit + "_" + csId;
          if (sessionStorage.getItem(onceKey) === "1") return;
          sessionStorage.setItem(onceKey, "1");

          activateRight().catch((err) => {
            console.error("[GhostOps activate-right] error:", err);
          });
        });
      })();
    </script>

    <!-- ✅ Auth guard centralisé (droits) -->
    <script src="/js/auth-guard.js"></script>

    <style>
      body::before {
        content: "";
        background: url("/assets/background-ghostops.jpg") no-repeat center center fixed;
        background-color: #0f172a;
        background-size: cover;
        animation: bgPulse 10s ease-in-out infinite alternate;
        position: fixed;
        inset: 0;
        opacity: 0.25;
        z-index: -1;
        transition: opacity 0.4s ease;
      }
      @keyframes bgPulse {
        0% {
          filter: brightness(1) contrast(1);
        }
        100% {
          filter: brightness(1.05) contrast(1.05);
        }
      }
      .text-shadow {
        text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.6);
      }
      html {
        scroll-behavior: smooth;
      }
      header,
      main,
      section,
      footer {
        position: relative;
        z-index: 1;
      }

      /* bulles */
      .bot-bubble {
        background: rgba(17, 24, 39, 0.75);
        border: 1px solid rgba(55, 65, 81, 1);
        border-radius: 0.9rem;
        padding: 0.85rem 0.9rem;
        white-space: normal;
        line-height: 1.55;
      }
      .user-bubble {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(148, 163, 184, 0.35);
        border-radius: 0.9rem;
        padding: 0.85rem 0.9rem;
        white-space: pre-wrap;
        line-height: 1.55;
      }
      .bot-bubble a {
        text-decoration: underline;
        text-decoration-style: dotted;
      }
      .bot-bubble ul {
        margin: 0.4rem 0 0.6rem 1.1rem;
        list-style: disc;
      }
      .bot-bubble li {
        margin: 0.18rem 0;
      }
      .bot-bubble p {
        margin: 0.35rem 0;
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New",
          monospace;
      }

      /* Focus visible */
      :focus-visible {
        outline: 2px solid rgba(255, 255, 255, 0.7);
        outline-offset: 2px;
      }
    </style>
  </head>

  <body class="bg-gray-900 text-white font-sans leading-relaxed">
    <!-- HEADER -->
    <header class="w-full px-6 md:px-16 py-4 flex items-center justify-between">
      <a href="/index.html" class="text-sm font-semibold tracking-[.25em] text-gray-200 hover:text-white uppercase">
        GHOST<span class="text-gray-400">OPS</span>
      </a>
      <nav class="flex items-center gap-4 text-xs md:text-sm">
        <a href="/index.html" class="text-gray-300 hover:text-white">Accueil</a>
        <a href="/expertise.html" class="text-gray-300 hover:text-white">Expertise</a>
        <a href="/qui-sommes-nous.html" class="text-gray-300 hover:text-white">Qui sommes-nous&nbsp;?</a>
        <a
          href="/contact.html"
          class="px-3 py-1 border border-gray-400 rounded-full hover:bg-gray-100 hover:text-black transition"
        >
          Contact confidentiel
        </a>
      </nav>
    </header>

    <main class="px-6 md:px-24 pb-24">
      <!-- BLOC SI ACCÈS REFUSÉ -->
      <section id="prebrief-not-paid" class="hidden max-w-3xl mx-auto mt-10 mb-10">
        <div class="bg-red-900/40 border border-red-500/70 rounded-2xl p-6 md:p-8">
          <h1 class="text-2xl md:text-3xl font-bold mb-3 text-white text-shadow">Accès réservé – GhostOps Pré-brief Board</h1>

          <p class="text-gray-200 text-sm md:text-base mb-3">
            Cette page est réservée aux dirigeants, boards ou directions ayant validé un
            <span class="font-semibold">GhostOps Pré-brief Board</span> via le module de paiement sécurisé.
          </p>

          <p class="text-gray-300 text-sm md:text-base mb-4">
            Si vous venez de payer, assurez-vous d’être connecté au bon compte, puis revenez via le lien de confirmation de paiement.
          </p>

          <div class="flex flex-col sm:flex-row gap-3 mt-4">
            <a
              href="/pre-brief-board.html"
              class="inline-block px-5 py-2 text-xs md:text-sm border border-white rounded-md hover:bg-white hover:text-black transition text-center"
            >
              Revenir à la page Pré-brief Board
            </a>
            <a
              href="/connexion.html"
              class="inline-block px-5 py-2 text-xs md:text-sm border border-gray-400 rounded-md hover:bg-gray-100 hover:text-black transition text-center"
            >
              Se connecter
            </a>
            <a
              href="/contact.html"
              class="inline-block px-5 py-2 text-xs md:text-sm border border-gray-400 rounded-md hover:bg-gray-100 hover:text-black transition text-center"
            >
              Contacter GhostOps
            </a>
          </div>

          <p id="prebrief-debug" class="text-gray-500 text-[11px] mt-4"></p>
        </div>
      </section>

      <!-- BLOC SI ACCÈS OK -->
      <section id="prebrief-paid" class="hidden max-w-5xl mx-auto mt-10 mb-10">
        <!-- Bandeau -->
        <div class="bg-emerald-900/40 border border-emerald-500/70 rounded-2xl p-4 mb-6">
          <p class="text-xs md:text-sm text-emerald-100">
            Votre accès au <span class="font-semibold">GhostOps Pré-brief Board</span> est actif.
            Cet espace vous permet de préparer et structurer votre dossier pour la note board-ready.
          </p>
        </div>

        <!-- Intro -->
        <header class="mb-8">
          <p class="text-xs uppercase tracking-[.25em] text-gray-400 mb-3">GhostOps IA · Pré-brief Board – Espace de travail</p>
          <h1 class="text-2xl md:text-3xl font-bold mb-4 text-white text-shadow">
            Session Pré-brief Board – préparation de la note board-ready
          </h1>
          <p class="text-gray-200 text-sm md:text-base mb-3 max-w-3xl">
            Vous avez activé un <span class="font-semibold">Pré-brief Board GhostOps</span>. L’objectif de cette session est de rassembler les
            éléments décisifs et de structurer le contexte avant la production de la <span class="font-semibold">note board-ready</span>.
          </p>
          <p class="text-gray-300 text-sm md:text-base max-w-3xl">
            GhostOps utilise l’IA comme instrument de lecture et de simulation. La note finale reste un
            <span class="font-semibold">livrable humain, assumé</span>.
          </p>
        </header>

        <!-- Télémétrie -->
        <section class="mb-6">
          <div class="bg-gray-800/70 rounded-2xl p-4 md:p-5 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div class="text-xs md:text-sm text-gray-200">
              <span class="text-gray-400">Session :</span>
              <span id="pb-meta-iters" class="font-semibold">—</span>
              <span class="text-gray-400">/</span>
              <span id="pb-meta-itersmax" class="font-semibold">—</span>
              <span class="text-gray-400">itérations</span>

              <span class="mx-2 text-gray-600">•</span>

              <span class="text-gray-400">TTL :</span>
              <span id="pb-meta-ttl" class="font-semibold">—</span>

              <span class="mx-2 text-gray-600">•</span>

              <span class="text-gray-400">Expiration :</span>
              <span id="pb-meta-exp" class="font-semibold">—</span>
            </div>

            <div class="flex flex-wrap items-center gap-2">
              <button
                id="pb-reset"
                type="button"
                class="px-3 py-2 text-[11px] md:text-xs border border-gray-500 rounded-md hover:bg-gray-100 hover:text-black transition"
              >
                Réinitialiser (token)
              </button>

              <button
                id="pb-hard-refresh"
                type="button"
                class="px-3 py-2 text-[11px] md:text-xs border border-gray-500 rounded-md hover:bg-gray-100 hover:text-black transition"
              >
                Recharger (sans cache)
              </button>

              <span id="pb-meta-tech" class="text-[11px] text-gray-400"></span>
            </div>
          </div>

          <p class="text-gray-500 text-[11px] mt-2">
            Indicateurs internes (itérations/TTL) affichés pour contrôler la stabilité de session.
          </p>
        </section>

        <!-- Étape 1 -->
        <section class="mb-8">
          <div class="bg-gray-800/80 rounded-2xl p-6 md:p-8">
            <h2 class="text-xl md:text-2xl font-semibold mb-3 text-white text-shadow">Étape&nbsp;1 – Préparer vos éléments de contexte</h2>
            <ul class="list-disc list-inside text-gray-300 text-sm md:text-base space-y-2 max-w-3xl">
              <li><span class="font-semibold">Périmètre</span> (groupe / filiale / site / fonctions).</li>
              <li><span class="font-semibold">Faits</span> : décisions, tensions, éléments datés.</li>
              <li><span class="font-semibold">Acteurs</span> : influence réelle, lignes de force, blocages.</li>
              <li><span class="font-semibold">Risques</span> : humains, conformité, réputation, exécution.</li>
              <li><span class="font-semibold">Échéances</span> : comité, board, jalons.</li>
            </ul>
            <p class="text-gray-400 text-xs md:text-sm mt-4 max-w-3xl">
              Vous pouvez saisir ces éléments directement dans le module IA ci-dessous.
            </p>
          </div>
        </section>

        <!-- Chat -->
        <section>
          <div class="bg-gray-900/80 border border-gray-700 rounded-2xl p-6 md:p-8">
            <h2 class="text-xl md:text-2xl font-semibold mb-3 text-white text-shadow">Étape&nbsp;2 – Pré-brief Board avec GhostOps IA</h2>

            <div class="bg-gray-950/80 rounded-xl border border-gray-700 max-h-[460px] flex flex-col">
              <div id="prebrief-chat-messages" class="flex-1 px-4 py-3 space-y-3 overflow-y-auto text-xs md:text-sm">
                <div class="bot-bubble text-gray-100" id="pb-welcome"></div>
              </div>

              <form id="prebrief-chat-form" class="border-t border-gray-800 px-3 py-2 flex items-center gap-2">
                <textarea
                  id="prebrief-chat-input"
                  class="flex-1 text-xs bg-gray-900 text-gray-100 border border-gray-700 rounded-md px-2 py-2 resize-none focus:outline-none focus:border-gray-400"
                  rows="3"
                  maxlength="6000"
                  placeholder="Décrivez ici votre situation (contexte, acteurs, risques, échéances)…"
                ></textarea>

                <div class="flex flex-col gap-2">
                  <button type="submit" class="text-xs px-3 py-2 bg-white text-black font-semibold rounded-md hover:bg-gray-200">
                    Envoyer
                  </button>

                  <button
                    id="pb-continue"
                    type="button"
                    class="text-xs px-3 py-2 border border-gray-500 rounded-md hover:bg-gray-100 hover:text-black transition disabled:opacity-40 disabled:cursor-not-allowed"
                    disabled
                    title="Demander la suite d’une réponse tronquée"
                  >
                    Suite
                  </button>
                </div>
              </form>
            </div>

            <p class="text-gray-500 text-[11px] mt-3 max-w-3xl">
              Ce module IA ne remplace pas un échange direct. La production de la note finale reste un livrable humain.
            </p>

            <p id="pb-status" class="text-xs text-gray-300 mt-3"></p>
          </div>
        </section>
      </section>
    </main>

    <footer class="w-full px-6 md:px-24 pb-8 mt-8 text-xs text-gray-400">
      <div class="max-w-5xl mx-auto flex flex-col md:flex-row md:items-center md:justify-between gap-2">
        <p>© GhostOps – Tous droits réservés.</p>
        <nav class="flex flex-wrap items-center gap-3">
          <a href="/" class="hover:underline">Accueil</a>
          <a href="/expertise.html" class="hover:underline">Expertise</a>
          <a href="/qui-sommes-nous.html" class="hover:underline">Qui sommes-nous&nbsp;?</a>
          <a href="/contact.html" class="hover:underline">Contact</a>
          <a href="/mentions-legales.html" class="hover:underline">Mentions légales &amp; confidentialité</a>
        </nav>
      </div>
    </footer>

    <script>
      (function () {
        // -----------------------------
        // Params
        // -----------------------------
        const params = new URLSearchParams(window.location.search);
        const csId = (params.get("cs_id") || "").trim();
        const activatedFlag = (params.get("activated") || "").trim(); // après activation-right + nettoyage URL
        const resetFlag = (params.get("reset") || "").trim();

        // -----------------------------
        // DOM
        // -----------------------------
        const paidBlock = document.getElementById("prebrief-paid");
        const notPaidBlock = document.getElementById("prebrief-not-paid");
        const debugEl = document.getElementById("prebrief-debug");

        const form = document.getElementById("prebrief-chat-form");
        const input = document.getElementById("prebrief-chat-input");
        const messages = document.getElementById("prebrief-chat-messages");
        const statusEl = document.getElementById("pb-status");

        const btnContinue = document.getElementById("pb-continue");
        const btnReset = document.getElementById("pb-reset");
        const btnHardRefresh = document.getElementById("pb-hard-refresh");

        const metaIters = document.getElementById("pb-meta-iters");
        const metaItersMax = document.getElementById("pb-meta-itersmax");
        const metaTtl = document.getElementById("pb-meta-ttl");
        const metaExp = document.getElementById("pb-meta-exp");
        const metaTech = document.getElementById("pb-meta-tech");

        const welcomeEl = document.getElementById("pb-welcome");

        // -----------------------------
        // Storage / State
        // -----------------------------
        const TOKEN_KEY = "ghostops_prebrief_sessionToken_v2";

        // Historique (comme N2)
        const history = [];
        let lastAssistantText = "";
        let truncMarkerFromApi = "— FIN TRONQUÉE (demander la suite)";

        // Anti double-submit
        let busy = false;

        // -----------------------------
        // Helpers : text -> HTML aéré
        // -----------------------------
        function escapeHtml(s) {
          return String(s || "")
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");
        }

        function linkify(s) {
          return s.replace(/\bhttps?:\/\/[^\s<]+/gi, (m) => {
            return `<a href="${m}" target="_blank" rel="noopener noreferrer">${m}</a>`;
          });
        }

        function formatAiTextToHtml(text) {
          const raw = String(text || "").trim();
          if (!raw) return "";

          const safe = escapeHtml(raw);
          const lines = safe.split(/\r?\n/);

          let html = "";
          let inList = false;

          function closeList() {
            if (inList) {
              html += "</ul>";
              inList = false;
            }
          }

          for (let i = 0; i < lines.length; i++) {
            const line = lines[i];

            if (!line.trim()) {
              closeList();
              html += "<p></p>";
              continue;
            }

            const titleMatch = line.match(/^\*\*(.+?)\*\*\s*$/);
            if (titleMatch) {
              closeList();
              html += `<p><strong>${titleMatch[1]}</strong></p>`;
              continue;
            }

            if (line.trim().startsWith("- ")) {
              if (!inList) {
                html += "<ul>";
                inList = true;
              }
              const item = line.trim().slice(2);
              html += `<li>${item}</li>`;
              continue;
            }

            closeList();
            html += `<p>${line}</p>`;
          }

          closeList();
          html = linkify(html);
          html = html.replace(/<p><\/p>/g, "<br/>");
          return html;
        }

        // -----------------------------
        // Typewriter (texte -> hydratation HTML)
        // -----------------------------
        async function typewriterInto(el, finalText, speedMs) {
          const text = String(finalText || "");
          el.textContent = "";
          for (let i = 0; i < text.length; i++) {
            el.textContent += text[i];
            if (i % 2 === 0) await new Promise((r) => setTimeout(r, speedMs));
          }
          el.innerHTML = formatAiTextToHtml(text);
        }

        // -----------------------------
        // UI helpers
        // -----------------------------
        function showPaid() {
          if (notPaidBlock) notPaidBlock.classList.add("hidden");
          if (paidBlock) paidBlock.classList.remove("hidden");
        }

        function showNotPaid(msg) {
          if (paidBlock) paidBlock.classList.add("hidden");
          if (notPaidBlock) notPaidBlock.classList.remove("hidden");
          if (debugEl) debugEl.textContent = msg || "";
        }

        function scrollToBottom() {
          if (!messages) return;
          messages.scrollTop = messages.scrollHeight;
        }

        function setStatus(text, tone) {
          if (!statusEl) return;
          statusEl.textContent = text || "";
          statusEl.className =
            "text-xs mt-3 " +
            (tone === "err" ? "text-red-400" : tone === "ok" ? "text-green-400" : "text-gray-300");
        }

        function fmtExp(expUnix) {
          if (!expUnix) return "—";
          const d = new Date(expUnix * 1000);
          try {
            return d.toLocaleString("fr-FR", { timeZone: "Europe/Paris" });
          } catch (_) {
            return d.toISOString();
          }
        }

        function fmtDuration(seconds) {
          const s = Math.max(0, Number(seconds || 0));
          const h = Math.floor(s / 3600);
          const m = Math.floor((s % 3600) / 60);
          const r = s % 60;
          if (h > 0) return `${h}h ${m}m`;
          if (m > 0) return `${m}m ${r}s`;
          return `${r}s`;
        }

        function updateMetaFromApi(data) {
          if (!data) return;

          if (typeof data.itersLeft === "number" && metaIters) metaIters.textContent = String(data.itersLeft);
          if (typeof data.expiresAt === "number" && metaExp) metaExp.textContent = fmtExp(data.expiresAt);

          const maxIters = data?.meta?.session?.maxIters;
          if (maxIters != null && metaItersMax) metaItersMax.textContent = String(maxIters);

          const ttlSeconds = data?.meta?.session?.ttlSeconds;
          if (ttlSeconds != null && metaTtl) metaTtl.textContent = fmtDuration(ttlSeconds);

          const bits = [];
          if (data?.meta?.model) bits.push("model=" + data.meta.model);
          if (data?.meta?.latencyMs != null) bits.push("lat=" + data.meta.latencyMs + "ms");
          if (data?.meta?.timeoutMs != null) bits.push("to=" + data.meta.timeoutMs + "ms");
          if (metaTech) metaTech.textContent = bits.length ? "(" + bits.join(" · ") + ")" : "";

          if (data?.meta?.truncMarker) truncMarkerFromApi = String(data.meta.truncMarker);
        }

        function tokenExists() {
          return Boolean((localStorage.getItem(TOKEN_KEY) || "").trim());
        }

        function purgeToken() {
          localStorage.removeItem(TOKEN_KEY);
        }

        function enableContinueIfNeeded(replyText) {
          const t = String(replyText || "");
          const truncated = (truncMarkerFromApi && t.includes(truncMarkerFromApi)) || /fin tronqu/i.test(t);
          if (btnContinue) btnContinue.disabled = !truncated;
        }

        function addUserMessage(text) {
          const wrapper = document.createElement("div");
          wrapper.className = "text-right";
          const bubble = document.createElement("div");
          bubble.className = "user-bubble inline-block text-gray-100";
          bubble.textContent = text;
          wrapper.appendChild(bubble);
          messages.appendChild(wrapper);
          scrollToBottom();
        }

        function addBotMessageContainer() {
          const wrapper = document.createElement("div");
          wrapper.className = "text-left";
          const bubble = document.createElement("div");
          bubble.className = "bot-bubble inline-block text-gray-100";
          bubble.textContent = "";
          wrapper.appendChild(bubble);
          messages.appendChild(wrapper);
          scrollToBottom();
          return bubble;
        }

        function setBusy(on) {
          busy = !!on;
          if (form) {
            const btn = form.querySelector('button[type="submit"]');
            if (btn) btn.disabled = busy;
          }
          if (btnContinue) btnContinue.disabled = busy ? true : btnContinue.disabled;
        }

        // -------------------------
        // Bootstrap accès (UI uniquement)
        // -------------------------
        async function bootstrapUI() {
          // reset=1 : purge token + nettoyage URL
          if (resetFlag === "1") {
            purgeToken();
            const url = new URL(window.location.href);
            url.searchParams.delete("reset");
            window.location.replace(url.toString());
            return;
          }

          // Par défaut, on attend l'event auth-guard pour trancher.
          // Mais on peut afficher un hint si l'utilisateur arrive post-Stripe.
          if (csId) {
            showPaid();
            setStatus("Accès en cours de vérification… (cs_id détecté)", "");
            return;
          }

          if (activatedFlag === "1") {
            showPaid();
            setStatus("Accès activé. Vérification en cours…", "");
            return;
          }

          if (tokenExists()) {
            showPaid();
            setStatus("Session détectée (token). Vérification en cours…", "");
            return;
          }

          // On affiche une vue neutre en attendant l'auth (évite flash rouge)
          showPaid();
          setStatus("Vérification d’accès en cours…", "");
        }

        // -------------------------
        // API call (no-store + timeout)
        // -------------------------
        async function callApi(payload) {
          const controller = new AbortController();
          const timeout = setTimeout(() => controller.abort(), 45000);

          try {
            const response = await fetch("/api/ghostops-pre-brief-board", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
              cache: "no-store",
              signal: controller.signal,
            });

            let data = {};
            try {
              data = await response.json();
            } catch (_) {}

            return { response, data };
          } finally {
            clearTimeout(timeout);
          }
        }

        // -------------------------
        // Send message
        // -------------------------
        async function sendUserMessage() {
          if (busy) return;

          const userMessage = (input.value || "").trim();
          if (!userMessage) return;

          addUserMessage(userMessage);
          input.value = "";

          history.push({ role: "user", content: userMessage });

          setStatus("Lecture Pré-brief Board en cours…", "");
          const botBubble = addBotMessageContainer();

          setBusy(true);

          try {
            const token = (localStorage.getItem(TOKEN_KEY) || "").trim();

            let payload;
            if (token) payload = { sessionToken: token, message: userMessage, history };
            else if (csId) payload = { cs_id: csId, message: userMessage, history };
            else payload = { message: userMessage, history };

            // ✅ Joindre JWT Supabase si dispo (utile si backend contrôle l’identité)
            try {
              const sb = window.ghostopsSupabase;
              if (sb?.auth?.getSession) {
                const { data: s } = await sb.auth.getSession();
                const accessToken = s?.session?.access_token;
                if (accessToken) payload.supabaseAccessToken = accessToken;
              }
            } catch (_) {}

            const { response, data } = await callApi(payload);

            if (!response.ok || !data.reply) {
              const errText = data?.error || `Erreur API Pré-brief Board (HTTP ${response.status}).`;
              botBubble.textContent = errText;
              setStatus(errText, "err");
              if (btnContinue) btnContinue.disabled = true;
              return;
            }

            if (data.sessionToken) localStorage.setItem(TOKEN_KEY, data.sessionToken);

            await typewriterInto(botBubble, data.reply, 8);

            history.push({ role: "assistant", content: data.reply });
            lastAssistantText = data.reply || lastAssistantText;

            updateMetaFromApi(data);
            enableContinueIfNeeded(data.reply);

            setStatus("Réponse générée.", "ok");
          } catch (err) {
            console.error("Erreur /api/ghostops-pre-brief-board :", err);
            const msg =
              err && err.name === "AbortError"
                ? "Délai dépassé (timeout). Veuillez réessayer."
                : "Erreur de connexion à GhostOps IA. Veuillez réessayer ou utiliser la page contact.";
            botBubble.textContent = msg;
            setStatus("Erreur réseau.", "err");
            if (btnContinue) btnContinue.disabled = true;
          } finally {
            setBusy(false);
          }
        }

        // -------------------------
        // Continue
        // -------------------------
        async function requestContinue() {
          if (busy) return;

          const token = (localStorage.getItem(TOKEN_KEY) || "").trim();
          if (!token) {
            const b = addBotMessageContainer();
            b.textContent =
              "Impossible de demander la suite : token de session absent. Relancez via le lien Stripe (cs_id).";
            setStatus("Suite impossible (token absent).", "err");
            return;
          }

          if (!lastAssistantText && history.length < 2) {
            const b = addBotMessageContainer();
            b.textContent = "Impossible de demander la suite : contexte insuffisant.";
            setStatus("Suite impossible (contexte insuffisant).", "err");
            return;
          }

          setStatus("Demande de suite…", "");
          const botBubble = addBotMessageContainer();

          setBusy(true);

          try {
            const payload = {
              sessionToken: token,
              continue: true,
              last_assistant: lastAssistantText,
              history,
            };

            // ✅ Joindre JWT Supabase si dispo
            try {
              const sb = window.ghostopsSupabase;
              if (sb?.auth?.getSession) {
                const { data: s } = await sb.auth.getSession();
                const accessToken = s?.session?.access_token;
                if (accessToken) payload.supabaseAccessToken = accessToken;
              }
            } catch (_) {}

            const { response, data } = await callApi(payload);

            if (!response.ok || !data.reply) {
              const errText = data?.error || `Erreur API Pré-brief Board (HTTP ${response.status}).`;
              botBubble.textContent = errText;
              setStatus(errText, "err");
              return;
            }

            if (data.sessionToken) localStorage.setItem(TOKEN_KEY, data.sessionToken);

            await typewriterInto(botBubble, data.reply, 8);

            history.push({ role: "assistant", content: data.reply });
            lastAssistantText = (lastAssistantText ? lastAssistantText + "\n\n" : "") + data.reply;

            updateMetaFromApi(data);
            enableContinueIfNeeded(data.reply);

            setStatus("Suite générée.", "ok");
          } catch (err) {
            console.error("Erreur suite Pré-brief Board:", err);
            botBubble.textContent =
              err && err.name === "AbortError"
                ? "Délai dépassé (timeout). Veuillez réessayer."
                : "Erreur réseau lors de la demande de suite. Veuillez réessayer.";
            setStatus("Erreur réseau (suite).", "err");
          } finally {
            setBusy(false);
          }
        }

        // -------------------------
        // Welcome message
        // -------------------------
        function renderWelcome() {
          const txt =
            "GhostOps IA – Pré-brief Board :\n\n" +
            "- Décrivez votre situation (périmètre, faits, acteurs, risques, échéances).\n" +
            "- Je produirai un pré-brief structuré : reformulation factuelle, enjeux de gouvernance, risques, options de cadrage, informations manquantes.\n" +
            "- Objectif : préparer une note et un ordre du jour exploitables en séance (board / comité d’audit).";
          if (welcomeEl) welcomeEl.innerHTML = formatAiTextToHtml(txt);
        }

        // -------------------------
        // Listeners
        // -------------------------
        if (form && input && messages) {
          form.addEventListener("submit", function (e) {
            e.preventDefault();
            sendUserMessage();
          });

          input.addEventListener("keydown", function (e) {
            if (e.key === "Enter" && !e.shiftKey) {
              e.preventDefault();
              sendUserMessage();
            }
          });
        }

        if (btnContinue) {
          btnContinue.addEventListener("click", function () {
            requestContinue();
          });
        }

        if (btnReset) {
          btnReset.addEventListener("click", function () {
            purgeToken();
            setStatus("Token supprimé. Si besoin, rechargez via le lien Stripe (cs_id).", "ok");
            if (btnContinue) btnContinue.disabled = true;
          });
        }

        if (btnHardRefresh) {
          btnHardRefresh.addEventListener("click", function () {
            const url = new URL(window.location.href);
            url.searchParams.set("t", String(Date.now()));
            window.location.replace(url.toString());
          });
        }

        // -------------------------
        // Auth Guard integration
        // -------------------------
        // auth-guard.js émet "ghostops:auth" avec { ok, reason, ... }
        window.addEventListener("ghostops:auth", function (ev) {
          try {
            const detail = ev?.detail || {};
            if (detail.ok) {
              showPaid();
              if (detail.reason === "activation_required") {
                setStatus("Paiement détecté. Activation en cours…", "");
              } else {
                setStatus("Accès validé.", "ok");
              }
              return;
            }

            const reason = detail.reason || "no_right";
            showNotPaid(
              "Accès refusé (" +
                reason +
                "). Vérifiez votre compte et vos droits, ou repassez par le lien de paiement."
            );
          } catch (_) {}
        });

        // Go
        renderWelcome();
        bootstrapUI();
      })();
    </script>
  </body>
</html>
